<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apple System Support</title>
    <style>
        .system-support-wrapper { background-color: var(--light-glass-bg); border-radius: var(--border-radius); margin: 10px; padding: 15px 10px 25px 10px; font-size: 14px; position: relative; }
        .system-support-wrapper h1 { font-size: 2rem; font-weight: 500; margin-bottom: 0.5rem; padding-left: 15px; }
        .system-support-wrapper .lead { padding: 0 15px 15px; margin-bottom: 1rem; font-size: 1rem; font-weight: 400; color: var(--light-text-secondary); border-bottom: 1px solid var(--light-border, rgba(0, 0, 0, 0.1)); }
        .system-support-wrapper h4 { font-size: 1.05rem; margin-bottom: 1rem; padding-left: 15px; }
        .system-support-wrapper .tab-link { color: #6c757d; font-weight: normal; text-decoration: none; cursor: pointer; transition: color 0.2s ease-in-out; }
        .system-support-wrapper .tab-link:hover { color: #000; }
        .system-support-wrapper .tab-link.active { color: #000; font-weight: bold; }
        .system-support-wrapper #sub-nav-container { margin-bottom: 1rem; font-size: 0.9rem; padding-left: 15px; transition: opacity 0.5s ease-in-out; will-change: opacity; }
        .system-support-wrapper #sub-nav-container.hide { opacity: 0; transition: opacity 0.5s ease-in-out; will-change: opacity; }
        .system-support-wrapper .table-responsive { width: 100%; overflow-x: auto; overflow-y: auto; transition: opacity 10s ease-in-out; opacity: 1; will-change: opacity; }
        .system-support-wrapper .table-responsive.fade-out { opacity: 0; transition: opacity 0.5s ease-in-out; }
        .system-support-wrapper .table-responsive.fade-in { opacity: 1; transition: opacity 0.5s ease-in-out; }
        .system-support-wrapper table { width: 100%; border-collapse: collapse; }
        .system-support-wrapper table th, .system-support-wrapper table td { padding: 0.7rem 0.75rem; vertical-align: middle; text-align: center; border-top: 1px solid #dee2e6; font-size: 13px; }
        .system-support-wrapper table th:first-child, .system-support-wrapper table td:first-child { text-align: left; }
        .system-support-wrapper thead { background-color: rgba(248, 249, 250, 0.95); will-change: transform; position: sticky; top: 0; z-index: 1; }
        .system-support-wrapper thead th { border-bottom: 2px solid #dee2e6; font-weight: 600; }
        .system-support-wrapper tbody { border-top: 2px solid #dee2e6; }
        .system-support-wrapper .glow-border, .system-support-wrapper .grayscale-border { border: none; }
        .system-support-wrapper .glow-border { box-shadow: 0 0 8px 2px rgb(46 188 255 / 70%), 0 0 8px 2px rgb(253 0 113 / 70%); }
        .system-support-wrapper .grayscale-border { box-shadow: 0 0 8px 2px rgb(150 150 150 / 60%); }
        .system-support-wrapper .os-support-cell { white-space: nowrap; text-align: left; }
        .system-support-wrapper .os-icon, .system-support-wrapper .img_null { width: 32px; height: 32px; margin: 1px 2px; vertical-align: middle; display: inline-block; border-radius: 7px; }
        .system-support-wrapper .os-icon.round { border-radius: 50%; }
        .system-support-wrapper .os-icon.tvos-image-shape, .system-support-wrapper .img_null_other { width: 42px; height: 32px; border-radius: 7px; display: inline-block; vertical-align: middle; margin: 1px 2px; }
        .system-support-wrapper .img_null_other_g { line-height: 32px; background-color: rgba(100, 100, 100, 0.1); color: #7a7a7a; font-weight: 500; font-size: 10px; border-radius: 7px; text-align: center; display: inline-block; vertical-align: middle; margin: 1px 2px; }
        .system-support-wrapper .img_null, .system-support-wrapper .img_null_other, .system-support-wrapper .img_null_other_g { border: 1px dashed rgba(150, 150, 150, 0.5); }
        .custom-tooltip {position: absolute; background-color: rgba(250, 250, 250, 0.9); color: #333; border: 1px solid rgba(0,0,0,0.1); border-radius: 8px; padding: 10px 14px; font-size: 13px; line-height: 1.5; z-index: 1070; width: max-content; max-width: 280px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); opacity: 0; transform: translateY(5px); transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out; visibility: hidden; }
        .custom-tooltip.glow-border { box-shadow: 0 0 8px 1px rgb(46 188 255 / 60%), 0 0 8px 1px rgb(253 0 113 / 60%); }
        .custom-tooltip.grayscale-border { box-shadow: 0 0 12px 3px rgb(150 150 150 / 60%); }
        .custom-tooltip.is-visible { opacity: 1; transform: translateY(0); visibility: visible; }
        .custom-tooltip .tooltip-arrow { position: absolute; width: 0; height: 0; border-style: solid; bottom: -6px; left: 50%; transform: translateX(-50%); border-width: 6px 6px 0 6px; border-color: rgba(250, 250, 250, 0.9) transparent transparent transparent; }

        @media (prefers-color-scheme: dark) {
            .system-support-wrapper { background-color: var(--dark-glass-bg); }
            .system-support-wrapper h1 { color: var(--dark-text-secondary); }
            .system-support-wrapper .lead { color: var(--dark-text-secondary); border-bottom-color: var(--dark-border, rgba(255, 255, 255, 0.15)); }
            .system-support-wrapper .tab-link { color: #888; }
            .system-support-wrapper .tab-link:hover { color: #ddd; }
            .system-support-wrapper .tab-link.active { color: #fff; }
            .system-support-wrapper thead { background-color: rgba(29, 29, 29, 0.95); }
            .system-support-wrapper table th, .system-support-wrapper table td, .system-support-wrapper tbody { border-color: #3a3a3a; }
            .system-support-wrapper .img_null_other_g { background-color: rgba(255, 255, 255, 0.15); color: #999; }
            .custom-tooltip { background-color: rgba(45, 45, 45, 0.9); color: #eee; border-color: rgba(255,255,255,0.2); }
            .custom-tooltip .tooltip-arrow { border-top-color: rgba(45, 45, 45, 0.9); }
        }

        @media (max-width: 768px) {
            .system-support-wrapper {
                padding: 20px;
                margin: 0;
            }
        }
    </style>
</head>
<body>
<div class="system-support-wrapper">
    <h1>Apple System Support</h1>
    <p class="lead">本页收集了 Apple 设备由官方和第三方提供支持的操作系统信息，仅包含可硬件加速的系统版本。</p>

    <h4 id="main-nav">
        <a href="#" class="tab-link" data-tab-group="main" data-tab-target="ios">iPhone</a> /
        <a href="#" class="tab-link" data-tab-group="main" data-tab-target="ipados">iPad</a> /
        <a href="#" class="tab-link" data-tab-group="main" data-tab-target="macos">Mac (Intel & Apple Silicon)</a> /
        <a href="#" class="tab-link" data-tab-group="main" data-tab-target="ipod">iPod touch</a> /
        <a href="#" class="tab-link" data-tab-group="main" data-tab-target="watchos">Watch</a> /
        <a href="#" class="tab-link" data-tab-group="main" data-tab-target="tvos">Apple TV</a> /
        <a href="#" class="tab-link" data-tab-group="main" data-tab-target="visionos">Apple Vision</a>
    </h4>

    <div id="sub-nav-container" hidden></div>
    <div class="table-responsive">
        <table class="table table-hover">
            <thead id="data-table-head"></thead>
            <tbody id="data-table-body"></tbody>
        </table>
    </div>
    
    <div id="custom-tooltip" class="custom-tooltip" role="tooltip">
        <div class="tooltip-content"></div>
        <div class="tooltip-arrow"></div>
    </div>
</div>

<script>
    async function fetchData(osKey) {
        try {
            const response = await fetch(`./apple-tools/support/data/${osKey}.json`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return await response.json();
        } catch (error) {
            console.error(`Could not fetch data for ${osKey}:`, error);
            document.getElementById('data-table-body').innerHTML = `<tr><td colspan="5" style="text-align:center;padding:2rem;">无法加载 ${osKey}.json。请按 F12 键查看控制台错误。</td></tr>`;
            return null;
        }
    }

    function createDeviceRow(device, allOsVersions, headers, currentOsKey, tooltipMessages) {
        const cells = [];
        const supportedSet = new Set(device.supportedOS || []);
        for (const header of headers) {
            if (header.key === 'os') {
                let osIconsHtml = allOsVersions.map(os_version => {
                    let baseIconClass = 'os-icon';
                    let baseNullClass = 'img_null';
                    if (currentOsKey === 'tvos') {
                        const osIdPrefix = os_version.id.split('_')[0];
                        if (osIdPrefix === 'tvos') {
                            baseIconClass = 'os-icon tvos-image-shape';
                            baseNullClass = 'img_null_other';
                        }
                    }

                    if (!supportedSet.has(os_version.id)) {
                        return `<div class="${baseNullClass}"></div>`;
                    }

                    const osName = os_version.name || os_version.id;
                    let additionalClass = device.iconClass || '';
                    let tooltipText = '';
                    const specialProp = device.special ? device.special[os_version.id] : null;

                    if (specialProp) {
                        const type = typeof specialProp === 'object' ? specialProp.type : specialProp;

                        if (typeof specialProp === 'object' && specialProp.tooltip) {
                            tooltipText = specialProp.tooltip;
                        }
                        else if (type === 'glow' && tooltipMessages.defaultGlow) {
                            tooltipText = tooltipMessages.defaultGlow.replace('{os_name}', osName);
                        } else if (type === 'grayscale' && tooltipMessages.defaultGray) {
                            tooltipText = tooltipMessages.defaultGray.replace('{os_name}', osName);
                        }
                        
                        if (type) {
                            additionalClass += ` ${type}-border`;
                        }
                    }
                    
                    if (!tooltipText && tooltipMessages.default) {
                        tooltipText = tooltipMessages.default.replace('{os_name}', osName);
                    }

                    const tooltipAttr = tooltipText ? `data-tooltip="${tooltipText}"` : `title="${osName}"`;
                    if (tooltipText) {
                        additionalClass += ' has-tooltip';
                    }
                    
                    const finalClass = `${baseIconClass} ${additionalClass.trim()}`;

                    return os_version.icon ?
                        `<img src="${os_version.icon}" class="${finalClass}" ${tooltipAttr}>` :
                        `<div class="${finalClass.replace(baseIconClass, '')} ${baseNullClass} img_null_other_g" ${tooltipAttr}>${os_version.name}</div>`;
                }).join('');
                cells.push(`<td class="os-support-cell">${osIconsHtml}</td>`);
            } else {
                cells.push(`<td>${device[header.key] || ''}</td>`);
            }
        }
        return `<tr>${cells.join('')}</tr>`;
    }

    function setupCustomTooltips() {
        const tooltipElement = document.getElementById('custom-tooltip');
        if (!tooltipElement) return;
        const contentElement = tooltipElement.querySelector('.tooltip-content');
        const container = document.querySelector('.system-support-wrapper');
        const tableBody = document.getElementById('data-table-body');
        if (!contentElement || !tableBody || !container) return;

        let hideTimeout;
        let isTooltipVisible = false;
        let currentTarget = null;
        
        const showTooltip = (target) => {
            const tooltipContent = target.dataset.tooltip;
            if (!tooltipContent) return;
            tooltipElement.classList.remove('glow-border', 'grayscale-border');
            if (target.classList.contains('glow-border')) {
                tooltipElement.classList.add('glow-border');
            } else if (target.classList.contains('grayscale-border')) {
                tooltipElement.classList.add('grayscale-border');
            }

            if (isTooltipVisible && target !== currentTarget) {
                tooltipElement.style.transition = 'none';
                tooltipElement.classList.remove('is-visible');
                tooltipElement.offsetHeight;
            }

            currentTarget = target;
            clearTimeout(hideTimeout);
            contentElement.innerHTML = tooltipContent;

            tooltipElement.style.transition = '';

            const targetRect = target.getBoundingClientRect();
            const containerRect = container.getBoundingClientRect();
            const tooltipRect = tooltipElement.getBoundingClientRect();

            let top = (targetRect.top - containerRect.top) - tooltipRect.height - 8;
            let left = (targetRect.left - containerRect.left) + (targetRect.width / 2) - tooltipRect.width / 2;

            if (left < 5) left = 5;
            if ((left + tooltipRect.width) > container.clientWidth) {
                left = container.clientWidth - tooltipRect.width - 5;
            }
            if ((targetRect.top - containerRect.top) < tooltipRect.height + 10) {
                top = (targetRect.bottom - containerRect.top) + 8;
            }

            tooltipElement.style.top = `${top}px`;
            tooltipElement.style.left = `${left}px`;
            tooltipElement.classList.add('is-visible');
            isTooltipVisible = true;
        };

        const hideTooltip = () => {
            hideTimeout = setTimeout(() => {
                tooltipElement.classList.remove('is-visible');
                isTooltipVisible = false;
                currentTarget = null;
            }, 200);
        };

        tableBody.addEventListener('mouseover', (e) => {
            const target = e.target.closest('.has-tooltip');
            if (target) {
                showTooltip(target);
            }
        });

        tableBody.addEventListener('mouseout', (e) => {
            const target = e.target.closest('.has-tooltip');
            if (target) {
                hideTooltip();
            }
        });

        tooltipElement.addEventListener('mouseenter', () => clearTimeout(hideTimeout));
        tooltipElement.addEventListener('mouseleave', hideTooltip);
    }

    function adjustTableHeight() {
        const tableContainer = document.querySelector('.table-responsive');
        if (!tableContainer) return;
        const topOffset = tableContainer.getBoundingClientRect().top;
        const bottomPadding = 60;
        const availableHeight = window.innerHeight - topOffset - bottomPadding;
        tableContainer.style.maxHeight = Math.max(250, availableHeight) + 'px';
    }

    function renderSubNav(osKey, categoryData) {
        const subNavContainer = document.getElementById('sub-nav-container');
        if (!subNavContainer) return;
        subNavContainer.innerHTML = '';
        if (categoryData && categoryData.categories) {
            const span = document.createElement('span');
            span.innerHTML = Object.keys(categoryData.categories).map((key, index) => {
                const category = categoryData.categories[key];
                return `<a href="#" class="tab-link ${index === 0 ? 'active' : ''}" data-tab-group="${osKey}" data-tab-target="${key}">${category.name}</a>`;
            }).join(' / ');
            subNavContainer.appendChild(span);
            subNavContainer.hidden = false;
        } else {
            subNavContainer.hidden = true;
        }
    }

    async function unifiedClickHandler(event) {
        const link = event.target.closest('.tab-link');
        if (!link || link.classList.contains('active')) {
            event.preventDefault();
            return;
        }
        event.preventDefault();
        const group = link.dataset.tabGroup;
        const target = link.dataset.tabTarget;
        const tableContainer = document.querySelector('.table-responsive');
        const subNavContainer = document.getElementById('sub-nav-container');
        document.querySelectorAll(`.tab-link[data-tab-group="${group}"]`).forEach(el => el.classList.remove('active'));
        link.classList.add('active');
        const osKey = group === 'main' ? target : group;
        const subKey = group === 'main' ? null : target;
        const categoryData = await fetchData(osKey);
        if (!categoryData) return;
        tableContainer.classList.remove('fade-in');
        tableContainer.classList.add('fade-out');
        if (group === 'main') {
            subNavContainer.classList.add('hide');
        }
        tableContainer.addEventListener('transitionend', () => {
            if (group === 'main') renderSubNav(osKey, categoryData);
            renderTable(osKey, categoryData, subKey);
            requestAnimationFrame(() => {
                tableContainer.classList.remove('fade-out');
                tableContainer.classList.add('fade-in');
                if (group === 'main') subNavContainer.classList.remove('hide');
                adjustTableHeight();
            });
        }, { once: true });
    }

    async function initializePage() {
        document.getElementById('main-nav').addEventListener('click', unifiedClickHandler);
        document.getElementById('sub-nav-container').addEventListener('click', unifiedClickHandler);
        const tableContainer = document.querySelector('.table-responsive');
        const subNavContainer = document.getElementById('sub-nav-container');
        tableContainer.classList.add('fade-out');
        subNavContainer.classList.add('hide');
        const defaultTab = document.querySelector('.tab-link[data-tab-target="ios"]');
        if (defaultTab) {
            const target = defaultTab.dataset.tabTarget;
            defaultTab.classList.add('active');
            const categoryData = await fetchData(target);
            if (categoryData) {
                renderSubNav(target, categoryData);
                renderTable(target, categoryData, null);
                tableContainer.classList.remove('fade-out');
                tableContainer.classList.add('fade-in');
                subNavContainer.classList.remove('hide');
            }
        }
        adjustTableHeight();
        setupCustomTooltips();
    }

    function renderTable(osKey, categoryData, subCategoryKey = null) {
        const tableHead = document.getElementById('data-table-head');
        const tableBody = document.getElementById('data-table-body');
        if (!tableHead || !tableBody || !categoryData) return;

        const tooltipMessages = categoryData.tooltipMessages || {};

        const headRow = document.createElement('tr');
        headRow.innerHTML = categoryData.headers.map(h => `<th width="${h.width || ''}">${h.text}</th>`).join('');
        tableHead.innerHTML = '';
        tableHead.appendChild(headRow);

        const bodyFragment = document.createDocumentFragment();
        let devicesToRender = [];
        if (categoryData.devices) {
            devicesToRender = categoryData.devices;
        } else if (categoryData.categories) {
            const key = subCategoryKey || Object.keys(categoryData.categories)[0];
            if (categoryData.categories[key] && categoryData.categories[key].devices) {
                devicesToRender = categoryData.categories[key].devices;
            }
        }
        devicesToRender.forEach(device => {
            if (osKey === 'watchos' || osKey === 'visionos') device.iconClass = 'round';
            const row = document.createElement('tr');
            row.innerHTML = createDeviceRow(device, categoryData.osVersions, categoryData.headers, osKey, tooltipMessages);
            bodyFragment.appendChild(row);
        });
        tableBody.innerHTML = '';
        tableBody.appendChild(bodyFragment);
    }

    window.addEventListener('resize', adjustTableHeight);
    initializePage();
</script>
</body>
</html>
