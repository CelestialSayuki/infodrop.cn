<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®ä¸Šä¼ ä¸­å¿ƒ</title>
    <style>
        .auth-wrapper { background-color: var(--light-glass-bg); border-radius: var(--border-radius); margin: 10px; padding: 30px; font-size: 14px; }
        .auth-wrapper h1 { font-size: 1.8rem; font-weight: 600; margin-bottom: 0.5rem; padding-left: 15px; }
        .auth-wrapper .lead { padding: 0 15px 15px; margin-bottom: 2rem; font-size: 1rem; font-weight: 400; color: var(--light-text-secondary); border-bottom: 1px solid var(--light-border); }
        .form-group { margin-bottom: 1.5rem; padding: 0 15px; }
        .btn { display: inline-block; padding: 12px 25px; font-size: 1rem; font-weight: 500; text-align: center; border-radius: 8px; border: none; cursor: pointer; transition: background-color 0.3s, transform 0.2s; }
        .btn-primary { background-color: var(--accent-color); color: white; width: 100%; }
        .btn:disabled { background-color: #e4e6eb; color: #bcc0c4; cursor: not-allowed; }
        .btn-primary:hover:not(:disabled) { background-color: var(--accent-color-hover); }
        .btn:active { transform: scale(0.98); }
        #dvfs-result-message { display: none; margin-top: 2rem; padding: 20px; border-radius: 10px; font-size: 1.1rem; font-weight: 500; text-align: left; line-height: 1.8; }
        #dvfs-result-message ul { padding-left: 20px; margin: 10px 0; }
        #dvfs-result-message li { margin-bottom: 5px; }
        .result-success { background-color: rgba(40, 201, 64, 0.15); color: #28C940; }
        .result-fail { background-color: rgba(255, 95, 87, 0.2); color: #FF5F57; }
        .result-processing { background-color: rgba(0, 122, 255, 0.1); color: var(--accent-color); text-align: center; }
        .file-input-wrapper { display: flex; align-items: center; border: 1px solid var(--light-border); border-radius: 8px; padding: 5px; background-color: rgba(255, 255, 255, 0.5); }
        input[type="file"] { display: none; }
        .file-input-label { padding: 8px 15px; background-color: #f0f0f0; border-radius: 6px; cursor: pointer; margin-right: 10px; color: #333; font-weight: 500; white-space: nowrap; }
        #ioservice-file-name { font-size: 0.9rem; color: var(--light-text-secondary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .sysdiagnose-tips { font-size: 0.9rem; color: var(--light-text-secondary); padding: 0 15px 15px; margin-top: -1rem; line-height: 1.5; }
        .sysdiagnose-tips strong { color: var(--light-text); }
        .result-success .copyable-hash {
            display: block;
            list-style-type: none;
            font-family: 'SF Mono', 'Menlo', 'Consolas', monospace;
            font-size: 0.9rem;
            color: var(--accent-color, #007aff);
            letter-spacing: 0.5px;
            padding: 8px 12px;
            margin: 8px 0;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.08);
            user-select: all;
            cursor: pointer;
            transition: background-color 0.2s;
            word-break: break-all;
        }
        .result-success .copyable-hash:hover {
            background-color: #f0f0f0;
        }
        #dvfs-result-message ul.hash-list {
             padding-left: 0;
             margin-top: 0;
        }
        .form-group.collapsible {
            transition: max-height 0.35s ease-out, opacity 0.3s ease-out, margin-bottom 0.35s ease-out;
            max-height: 0;
            opacity: 0;
            margin-bottom: 0 !important;
            overflow: hidden;
        }
        .form-group.collapsible.is-visible {
            max-height: 150px;
            opacity: 1;
            margin-bottom: 1.5rem !important;
        }
        .task-options-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .task-options-list li {
            position: relative;
            padding: 12px 15px;
            margin-bottom: 8px;
            border-radius: 8px;
            border: 1px solid var(--light-border);
            transition: background-color 0.2s, border-color 0.2s;
            cursor: pointer;
        }
        .task-options-list li:hover {
            background-color: rgba(0, 122, 255, 0.05);
        }
        .task-options-list li.selected {
             background-color: rgba(0, 122, 255, 0.1);
             border-color: var(--accent-color);
        }
        .task-options-list input[type="checkbox"] {
            opacity: 0;
            position: absolute;
            width: 0;
            height: 0;
        }
        .task-options-list label {
            cursor: inherit;
            display: block;
            width: 100%;
            font-weight: 500;
            color: var(--light-text);
            user-select: none;
        }
        .result-wrapper {
            display: none;
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--light-border);
        }
        .result-wrapper h3 {
            margin: 0 0 10px;
            padding: 0 15px;
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--light-text);
        }
        #asptool-file-name {
            font-size: 0.9rem; color: var(--light-text-secondary);
            overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
        }
        #disk-result-message,
        #screen-result-message {
            display: none; margin-top: 1rem; padding: 20px;
            border-radius: 10px; font-size: 1.1rem; font-weight: 500;
            text-align: left; line-height: 1.8;
        }
        #disk-result-message ul,
        #screen-result-message ul { padding-left: 20px; margin: 10px 0; }
        #disk-result-message li,
        #screen-result-message li { margin-bottom: 5px; }
        
        .macos-window.dark-mode .auth-wrapper,
        html.dark-mode .auth-wrapper { background-color: var(--dark-glass-bg); }
        .macos-window.dark-mode .auth-wrapper h1,
        .macos-window.dark-mode .auth-wrapper .lead,
        html.dark-mode .auth-wrapper h1,
        html.dark-mode .auth-wrapper .lead { color: var(--dark-text); }
        .macos-window.dark-mode .auth-wrapper .lead,
        html.dark-mode .auth-wrapper .lead { border-bottom-color: var(--dark-border); }
        .macos-window.dark-mode .btn:disabled,
        html.dark-mode .btn:disabled { background-color: #4a4a4a; color: #8a8a8a; }
        .macos-window.dark-mode .result-success,
        html.dark-mode .result-success { background-color: rgba(40, 201, 64, 0.2); }
        .macos-window.dark-mode .result-fail,
        html.dark-mode .result-fail { background-color: rgba(255, 95, 87, 0.25); }
        .macos-window.dark-mode .result-processing,
        html.dark-mode .result-processing { background-color: rgba(0, 122, 255, 0.2); }
        .macos-window.dark-mode .file-input-wrapper,
        html.dark-mode .file-input-wrapper { border-color: var(--dark-border); background-color: rgba(0, 0, 0, 0.2); }
        .macos-window.dark-mode .file-input-label,
        html.dark-mode .file-input-label { background-color: #4f4f52; color: var(--dark-text); }
        .macos-window.dark-mode #ioservice-file-name,
        html.dark-mode #ioservice-file-name { color: #a9a9a9; }
        .macos-window.dark-mode .sysdiagnose-tips,
        html.dark-mode .sysdiagnose-tips { color: #a9a9a9; }
        .macos-window.dark-mode .sysdiagnose-tips strong,
        html.dark-mode .sysdiagnose-tips strong { color: var(--dark-text); }
        html.dark-mode .result-success .copyable-hash {
            background-color: rgba(0, 0, 0, 0.25);
            color: #8ab4f8;
        }
        html.dark-mode .result-success .copyable-hash:hover {
            background-color: rgba(0, 0, 0, 0.4);
        }
        .macos-window.dark-mode #asptool-file-name,
        html.dark-mode #asptool-file-name {
            color: #a9a9a9;
        }

        .macos-window.dark-mode .task-options-list li,
        html.dark-mode .task-options-list li {
            border-color: var(--dark-border);
        }
        .macos-window.dark-mode .task-options-list li:hover,
        html.dark-mode .task-options-list li:hover {
            background-color: rgba(138, 180, 248, 0.1);
        }
        .macos-window.dark-mode .task-options-list li.selected,
        html.dark-mode .task-options-list li.selected {
            background-color: rgba(138, 180, 248, 0.2);
            border-color: #8ab4f8;
        }
        .macos-window.dark-mode .task-options-list label,
        html.dark-mode .task-options-list label {
             color: var(--dark-text);
        }
        .macos-window.dark-mode .result-wrapper,
        html.dark-mode .result-wrapper {
            border-top-color: var(--dark-border);
        }
        .macos-window.dark-mode .result-wrapper h3,
        html.dark-mode .result-wrapper h3 {
            color: var(--dark-text);
        }
        @media (max-width: 768px) {
            .auth-wrapper {
                padding: 20px;
                margin: 0;
            }
        }
    </style>
</head>
<body>
    <div class="auth-wrapper">
        <div id="upload-section">
            <h1>ğŸ“Š æ•°æ®ä¸Šä¼ ä¸­å¿ƒ</h1>
            <p class="lead">è¯·ä¸Šä¼ æ–‡ä»¶å¹¶é€‰æ‹©éœ€è¦æ‰§è¡Œçš„åˆ†æä»»åŠ¡ã€‚</p>
            <div class="sysdiagnose-tips">
                <p><strong>å¦‚ä½•è§¦å‘ Sysdiagnoseï¼š</strong></p>
                <ul>
                    <li><a href="https://hcsonline.com/images/PDFs/Sysdiagnose.pdf" target="_blank">Sysdiagnose è¯¦ç»†è¯´æ˜</a></li>
                </ul>
            </div>
            <div class="form-group collapsible" id="asptool-input-group">
                <label style="display: block; font-weight: 500; margin-bottom: 0.5rem;">asptool_snapshot</label>
                <div class="file-input-wrapper">
                    <label for="asptool-file-upload" class="file-input-label">é€‰æ‹©æ–‡ä»¶...</label>
                    <span id="asptool-file-name">å°šæœªé€‰æ‹©æ–‡ä»¶</span>
                    <input type="file" id="asptool-file-upload" accept=".txt,.log,text/plain">
                </div>
            </div>
            <div class="form-group">
                <label style="display: block; font-weight: 500; margin-bottom: 0.5rem;">IOService / IODeviceTree (.txt)</label>
                <div class="file-input-wrapper">
                    <label for="ioservice-file-upload" class="file-input-label">é€‰æ‹©æ–‡ä»¶...</label>
                    <span id="ioservice-file-name">å°šæœªé€‰æ‹©æ–‡ä»¶</span>
                    <input type="file" id="ioservice-file-upload" accept=".txt,.log,text/plain">
                </div>
            </div>
            <div class="form-group">
                <label style="display: block; font-weight: 500; margin-bottom: 0.5rem;">é€‰æ‹©åˆ†æä»»åŠ¡</label>
                <ul class="task-options-list">
                    <li class="selected" id="li-chk-dvfs">
                        <input type="checkbox" id="chk-dvfs" value="dvfs" checked>
                        <label for="chk-dvfs">è§£æ DVFS æ•°æ®</label>
                    </li>
                    <li id="li-chk-disk">
                        <input type="checkbox" id="chk-disk" value="disk">
                        <label for="chk-disk">è§£æç£ç›˜æ•°æ®</label>
                    </li>
                    <li id="li-chk-screen">
                        <input type="checkbox" id="chk-screen" value="screen">
                        <label for="chk-screen">è§£æå±å¹•</label>
                    </li>
                    </ul>
            </div>
            <div class="form-group">
                <button id="global-upload-btn" class="btn btn-primary" disabled>ä¸Šä¼ å¹¶åˆ†æ</button>
            </div>
        </div>
        <div id="dvfs-result-wrapper" class="result-wrapper">
            <h3>ğŸ“Š DVFS åˆ†æç»“æœ</h3>
            <div id="dvfs-result-message"></div>
        </div>

        <div id="disk-result-wrapper" class="result-wrapper">
            <h3>ğŸ’½ ç£ç›˜åˆ†æç»“æœ</h3>
            <div id="disk-result-message"></div>
        </div>

        <div id="screen-result-wrapper" class="result-wrapper">
            <h3>ğŸ–¥ï¸ å±å¹•åˆ†æç»“æœ</h3>
            <div id="screen-result-message"></div>
        </div>
        </div>
    <script>
        (function() {
            const windowRoot = document.currentScript ? document.currentScript.closest('.macos-window') || document.body : document.body;
            if (!windowRoot) {
                console.error("Upload UI: windowRoot not found in DOM.");
                return;
            }
            const iosFileInput = windowRoot.querySelector('#ioservice-file-upload');
            const iosFileName = windowRoot.querySelector('#ioservice-file-name');
            const asptoolFileInput = windowRoot.querySelector('#asptool-file-upload');
            const asptoolFileName = windowRoot.querySelector('#asptool-file-name');
            const asptoolGroup = windowRoot.querySelector('#asptool-input-group');
            
            const chkDvfs = windowRoot.querySelector('#chk-dvfs');
            const chkDisk = windowRoot.querySelector('#chk-disk');
            const chkScreen = windowRoot.querySelector('#chk-screen');
            
            const dvfsLi = windowRoot.querySelector('#li-chk-dvfs');
            const diskLi = windowRoot.querySelector('#li-chk-disk');
            const screenLi = windowRoot.querySelector('#li-chk-screen');

            const uploadBtn = windowRoot.querySelector('#global-upload-btn');
            
            const dvfsResultWrapper = windowRoot.querySelector('#dvfs-result-wrapper');
            const dvfsResultMessage = windowRoot.querySelector('#dvfs-result-message');
            const diskResultWrapper = windowRoot.querySelector('#disk-result-wrapper');
            const diskResultMessage = windowRoot.querySelector('#disk-result-message');
            const screenResultWrapper = windowRoot.querySelector('#screen-result-wrapper');
            const screenResultMessage = windowRoot.querySelector('#screen-result-message');

            let ioserviceFile = null;
            let asptoolFile = null;

            iosFileInput.addEventListener('change', () => {
                if (iosFileInput.files.length > 0) {
                    ioserviceFile = iosFileInput.files[0];
                    iosFileName.textContent = ioserviceFile.name;
                } else {
                    ioserviceFile = null;
                    iosFileName.textContent = 'å°šæœªé€‰æ‹©æ–‡ä»¶';
                }
                checkFormValidity();
            });

            asptoolFileInput.addEventListener('change', () => {
                if (asptoolFileInput.files.length > 0) {
                    asptoolFile = asptoolFileInput.files[0];
                    asptoolFileName.textContent = asptoolFile.name;
                } else {
                    asptoolFile = null;
                    asptoolFileName.textContent = 'å°šæœªé€‰æ‹©æ–‡ä»¶';
                }
                checkFormValidity();
            });

            dvfsLi.addEventListener('click', () => {
                chkDvfs.checked = !chkDvfs.checked;
                dvfsLi.classList.toggle('selected', chkDvfs.checked);
                checkFormValidity();
            });
            
            diskLi.addEventListener('click', () => {
                chkDisk.checked = !chkDisk.checked;
                diskLi.classList.toggle('selected', chkDisk.checked);
                asptoolGroup.classList.toggle('is-visible', chkDisk.checked);
                checkFormValidity();
            });

            screenLi.addEventListener('click', () => {
                chkScreen.checked = !chkScreen.checked;
                screenLi.classList.toggle('selected', chkScreen.checked);
                checkFormValidity();
            });

            uploadBtn.addEventListener('click', handleUpload);

            function checkFormValidity() {
                const dvfsChecked = chkDvfs.checked;
                const diskChecked = chkDisk.checked;
                const screenChecked = chkScreen.checked;
                let isReady = false;

                if (!dvfsChecked && !diskChecked && !screenChecked) {
                    isReady = false;
                } else if (!ioserviceFile) {
                    isReady = false;
                } else if (diskChecked && !asptoolFile) {
                    isReady = false;
                } else {
                    isReady = true;
                }
                
                uploadBtn.disabled = !isReady;
            }

            async function handleUpload() {
                uploadBtn.disabled = true;
                uploadBtn.textContent = 'æ­£åœ¨å¤„ç†...';
                dvfsResultWrapper.style.display = 'none';
                diskResultWrapper.style.display = 'none';
                screenResultWrapper.style.display = 'none';
                dvfsResultMessage.style.display = 'none';
                diskResultMessage.style.display = 'none';
                screenResultMessage.style.display = 'none';

                const dvfsChecked = chkDvfs.checked;
                const diskChecked = chkDisk.checked;
                const screenChecked = chkScreen.checked;

                try {
                    if (dvfsChecked) {
                        await processDVFS(ioserviceFile, dvfsResultMessage);
                    }
                    if (diskChecked) {
                        await processDisk(ioserviceFile, asptoolFile, diskResultMessage);
                    }
                    if (screenChecked) {
                        await processScreen(ioserviceFile, screenResultMessage);
                    }
                } catch (error) {
                    console.error("å¤„ç†ä»»åŠ¡æ—¶å‘ç”Ÿæ„å¤–é”™è¯¯:", error);
                } finally {
                    uploadBtn.disabled = false;
                    uploadBtn.textContent = 'ä¸Šä¼ å¹¶åˆ†æ';
                    checkFormValidity();
                }
            }

            async function processDVFS(file, resultMessageElement) {
                dvfsResultWrapper.style.display = 'block';
                resultMessageElement.style.display = 'block';
                resultMessageElement.className = 'result-processing';
                resultMessageElement.innerHTML = 'æ­£åœ¨åˆ†æ DVFS æ•°æ®...';
                
                const formData = new FormData();
                formData.append('dvfs_data_file', file);

                try {
                    const response = await fetch('./upload/dvfs/dvfs.php', { method: 'POST', body: formData });

                    if (!response.ok) {
                        let errorMsg = `æœåŠ¡å™¨é”™è¯¯ (çŠ¶æ€ç : ${response.status})`;
                        try { const errorResult = await response.json(); if (errorResult && errorResult.message) { errorMsg = errorResult.message; } } catch (e) {}
                        throw new Error(errorMsg);
                    }

                    const result = await response.json();
                    if (result.error) { throw new Error(result.error); }
                    if (!result.success) { throw new Error(result.message); }
                    
                    let html = result.message;
                    if (result.success && result.hashes && result.hashes.length > 0) {
                        html += "<br><p style='margin-top: 15px; margin-bottom: 5px;'><strong>å­˜å…¥æ•°æ®åº“çš„æ•°æ®è¡Œ Hashes:</strong></p>";
                        html += "<ul class='hash-list'>";
                        result.hashes.forEach(hash => {
                            html += `<li class="copyable-hash" data-original-text="${hash}">${hash}</li>`;
                        });
                        html += "</ul>";
                    }
                    
                    resultMessageElement.innerHTML = html;
                    resultMessageElement.className = result.success ? 'result-success' : 'result-fail';

                    if (result.success && result.hashes && result.hashes.length > 0) {
                        const hashElements = resultMessageElement.querySelectorAll('.copyable-hash');
                        hashElements.forEach(el => {
                            el.addEventListener('click', () => copyHashToClipboard(el));
                        });
                    }
                } catch (error) {
                    console.error("DVFS å¤„ç†å¤±è´¥:", error);
                    resultMessageElement.innerHTML = `DVFS å¤„ç†å¤±è´¥ï¼š${error.message}`;
                    resultMessageElement.className = 'result-fail';
                }
            }

            async function processDisk(iosFile, aspFile, resultMessageElement) {
                diskResultWrapper.style.display = 'block';
                resultMessageElement.style.display = 'block';
                resultMessageElement.className = 'result-processing';
                resultMessageElement.innerHTML = 'æ­£åœ¨åˆ†æç£ç›˜æ•°æ®...';
                
                const formData = new FormData();
                formData.append('ioservice_file', iosFile);
                formData.append('asptool_file', aspFile);

                try {
                    const response = await fetch('./upload/disk/disk.php', { method: 'POST', body: formData });
                    
                    if (!response.ok) {
                        let errorMsg = `æœåŠ¡å™¨é”™è¯¯ (çŠ¶æ€ç : ${response.status})`;
                        try { const errorResult = await response.json(); if (errorResult && errorResult.message) { errorMsg = errorResult.message; } } catch (e) {}
                        throw new Error(errorMsg);
                    }
                    
                    const result = await response.json();
                    if (!result.success) {
                        throw new Error(result.message || 'æœªçŸ¥çš„æœåŠ¡å™¨é”™è¯¯');
                    }
                    
                    resultMessageElement.innerHTML = result.message;
                    resultMessageElement.className = 'result-success';
                } catch (error) {
                    console.error("ç£ç›˜å¤„ç†å¤±è´¥:", error);
                    resultMessageElement.innerHTML = `ç£ç›˜å¤„ç†å¤±è´¥ï¼š${error.message}`;
                    resultMessageElement.className = 'result-fail';
                }
            }

            async function processScreen(file, resultMessageElement) {
                screenResultWrapper.style.display = 'block';
                resultMessageElement.style.display = 'block';
                resultMessageElement.className = 'result-processing';
                resultMessageElement.innerHTML = 'æ­£åœ¨åˆ†æå±å¹•åºåˆ—å·...';
                
                const formData = new FormData();
                formData.append('ioservice_file', file);

                try {
                    const response = await fetch('./upload/screen/screen.php', { method: 'POST', body: formData });

                    if (!response.ok) {
                        let errorMsg = `æœåŠ¡å™¨é”™è¯¯ (çŠ¶æ€ç : ${response.status})`;
                        try { const errorResult = await response.json(); if (errorResult && errorResult.message) { errorMsg = errorResult.message; } } catch (e) {}
                        throw new Error(errorMsg);
                    }

                    const result = await response.json();
                    if (!result.success) {
                        throw new Error(result.message);
                    }
                    
                    let html = `<strong>${result.message}</strong>`;
                    if (result.success && result.è®¾å¤‡å‹å·) {
                        html += "<ul style='padding-left: 20px; margin-top: 10px;'>";
                        html += `<li><strong>è®¾å¤‡å‹å·ï¼š</strong> ${result.è®¾å¤‡å‹å·}</li>`;
                        html += `<li><strong>å±å¹•åºåˆ—å·ï¼š</strong> ${result.å±å¹•åºåˆ—å·}</li>`;
                        html += `<li><strong>å‚å®¶ï¼š</strong> ${result.å‚å®¶}</li>`;
                        html += "</ul>";
                    }
                    
                    resultMessageElement.innerHTML = html;
                    resultMessageElement.className = 'result-success';

                } catch (error) {
                    console.error("å±å¹•åºåˆ—å·å¤„ç†å¤±è´¥:", error);
                    resultMessageElement.innerHTML = `å±å¹•åºåˆ—å·å¤„ç†å¤±è´¥ï¼š${error.message}`;
                    resultMessageElement.className = 'result-fail';
                }
            }

            function copyHashToClipboard(el) {
                const textToCopy = el.dataset.originalText;
                navigator.clipboard.writeText(textToCopy).then(() => {
                    const originalText = el.dataset.originalText;
                    el.textContent = 'å·²å¤åˆ¶!';
                    setTimeout(() => {
                        el.textContent = originalText;
                    }, 1500);
                }).catch(err => {
                    console.error('å¤åˆ¶å¤±è´¥: ', err);
                    alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ã€‚');
                });
            }
            if (!dvfsLi || !diskLi || !screenLi) {
                console.error("Missing li IDs. Please add id='li-chk-dvfs', id='li-chk-disk', and id='li-chk-screen' to the <li> elements.");
            }
            checkFormValidity();
        })();
    </script>
</body>
</html>
