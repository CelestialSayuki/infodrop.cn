<!DOCTYPE html>
<html lang="zh-CN" style="height: 100%">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>设备屏幕厂家分析</title>
  <link rel="stylesheet" type="text/css" href="../../public-static/css/new.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.5.0/echarts.min.js"></script>
  <style type="text/css">
    .main-content { padding: 20px; }
    .card { margin-bottom: 20px; }
    .retext { text-align: center; font-size: 1.2rem; font-weight: 500; margin-top: 20px; margin-bottom: 20px; color: var(--light-text-secondary); width: 100%; }
    hr { border: 0; height: 1px; background-color: rgba(237, 237, 237, 0.3); max-width: 1500px; margin: 40px auto; }
    #mainLayout { margin: 0; }
    .macos-window.dark-mode .retext, html.dark-mode .retext { color: var(--dark-text-secondary); }
    .macos-window.dark-mode hr, html.dark-mode hr { background-color: rgba(255, 255, 255, 0.15); }
    .macos-window.dark-mode .card, html.dark-mode .card { box-shadow: 0 2px 4px rgba(255, 255, 255, 0.05); }
    @media (max-width: 768px) {
      .main-content { padding: 5px; }
      .card { margin: 0; }
    }
  </style>
</head>
<body style="margin: 0;" id="mainLayout">
  <div class="main-content">
    <div class="card">
        <div id="screen-pie-chart" style="width: 100%; height: 600px;"></div>
    </div>
  </div>
  <script type="text/javascript">
    (async () => {
      let screenChartInstance = null;
      let allScreenData = null;
      let allDeviceNames = [];
      let currentSelectedDevice = '所有设备';
      const chartDom = document.getElementById('screen-pie-chart');
      const base64ToArrayBuffer = (base64) => {
          const binaryString = window.atob(base64);
          const len = binaryString.length;
          const bytes = new Uint8Array(len);
          for (let i = 0; i < len; i++) {
              bytes[i] = binaryString.charCodeAt(i);
          }
          return bytes.buffer;
      };
      const decryptData = async (keyData, b64Ciphertext, b64Iv, b64Tag) => {
          const cryptoKey = await window.crypto.subtle.importKey(
              "raw",
              keyData,
              { name: "AES-GCM" },
              false,
              ["decrypt"]
          );
          const ciphertext = base64ToArrayBuffer(b64Ciphertext);
          const iv = base64ToArrayBuffer(b64Iv);
          const tag = base64ToArrayBuffer(b64Tag);
          const fullCiphertext = new Uint8Array(ciphertext.byteLength + tag.byteLength);
          fullCiphertext.set(new Uint8Array(ciphertext), 0);
          fullCiphertext.set(new Uint8Array(tag), ciphertext.byteLength);
          const decrypted = await window.crypto.subtle.decrypt(
              {
                  name: "AES-GCM",
                  iv: iv,
                  tagLength: 128
              },
              cryptoKey,
              fullCiphertext.buffer
          );
          return new TextDecoder().decode(decrypted);
      };
      const getChartTheme = () => document.documentElement.classList.contains('dark-mode') ? 'dark' : 'light';
      const lightTooltipStyle = {
          backgroundColor: 'rgba(255, 255, 255, 0.5)',
          borderColor: '#E0E0E0',
          textStyle: { color: '#333' }
      };
      const darkTooltipStyle = {
          backgroundColor: 'rgba(50, 50, 50, 0.5)',
          borderColor: '#555',
          textStyle: { color: '#FFFFFF' }
      };
      function updateChartOptions(selectedDevice) {
          if (!allScreenData || !screenChartInstance) return;
          currentSelectedDevice = selectedDevice;
          let filteredData = allScreenData;
          if (selectedDevice !== '所有设备') {
              filteredData = allScreenData.filter(item => item.device_model === selectedDevice);
          }
          const manufacturerCounts = {};
          filteredData.forEach(item => {
              const manufacturer = item.manufacturer || "未知厂商";
              manufacturerCounts[manufacturer] = (manufacturerCounts[manufacturer] || 0) + 1;
          });
          const pieData = Object.entries(manufacturerCounts).map(([name, value]) => ({
              name: name,
              value: value
          }));
          const manufacturerNames = pieData.map(d => d.name);
          const totalCount = filteredData.length;
          let subtext = selectedDevice;
          subtext += ` (总计: ${totalCount} 台)`;
          screenChartInstance.setOption({
              title: {
                  subtext: subtext
              },
              legend: [
                  {
                      id: 'deviceFilter',
                      selected: { [selectedDevice]: true }
                  },
                  {
                      id: 'manufacturerLegend',
                      data: manufacturerNames
                  }
              ],
              series: {
                  id: 'mainPie',
                  data: pieData
              }
          });
      }
      function renderScreenChart(selectedDevice) {
          if (!allScreenData) return;
          if (!chartDom) return;
          currentSelectedDevice = selectedDevice;
          if (screenChartInstance) {
              screenChartInstance.dispose();
          }
          if (!allScreenData || allScreenData.length === 0) {
              chartDom.innerHTML = `<div class="retext">无可用数据。<br>请先通过上传页面提交数据。</div>`;
              chartDom.style.height = '100px';
              return;
          } else {
              chartDom.style.height = '600px';
          }
          const theme = getChartTheme();
          screenChartInstance = echarts.init(chartDom, theme);
          let filteredData = allScreenData;
          if (selectedDevice !== '所有设备') {
              filteredData = allScreenData.filter(item => item.device_model === selectedDevice);
          }
          const manufacturerCounts = {};
          filteredData.forEach(item => {
              const manufacturer = item.manufacturer || "未知厂商";
              manufacturerCounts[manufacturer] = (manufacturerCounts[manufacturer] || 0) + 1;
          });
          const pieData = Object.entries(manufacturerCounts).map(([name, value]) => ({
              name: name,
              value: value
          }));
          const manufacturerNames = pieData.map(d => d.name);
          const totalCount = filteredData.length;
          let subtext = selectedDevice + ` (总计: ${totalCount} 台)`;
          const option = {
              backgroundColor: 'transparent',
              title: {
                  text: '屏幕厂家占比',
                  subtext: subtext,
                  left: 'center'
              },
              tooltip: {
                  trigger: 'item',
                  formatter: '{b} : {c} 台 ({d}%)',
                  ...(theme === 'dark' ? darkTooltipStyle : lightTooltipStyle)
              },
              legend: [
                  {
                      id: 'deviceFilter',
                      data: allDeviceNames,
                      selected: { [selectedDevice]: true },
                      selectedMode: 'single',
                      orient: 'vertical',
                      left: '3%',
                      top: 'middle',
                      type: 'scroll',
                      textStyle: { fontSize: 11 }
                  },
                  {
                      id: 'manufacturerLegend',
                      data: manufacturerNames,
                      selectedMode: false,
                      orient: 'vertical',
                      right: '3%',
                      top: 'middle',
                      type: 'scroll',
                      textStyle: { fontSize: 11 }
                  }
              ],
              series: [
                  {
                      id: 'dummySeriesForFilter',
                      type: 'pie',
                      radius: ['0%', '1%'],
                      center: ['-100%', '-100%'],
                      data: allDeviceNames.map(name => ({ name: name, value: 0 })),
                      legendIndex: 0,
                      silent: true,
                      label: { show: false },
                      tooltip: { show: false }
                  },
                  {
                      id: 'mainPie',
                      name: '厂家分布',
                      type: 'pie',
                      radius: ['40%', '70%'],
                      center: ['50%', '50%'],
                      avoidLabelOverlap: true,
                      legendIndex: 1,
                      color: [
                        '#5470c6', '#91cc75', '#fac858', '#ee6666', '#73c0de',
                        '#3ba272', '#fc8452', '#9a60b4', '#ea7ccc'
                      ],
                      itemStyle: {
                          borderRadius: 10,
                          borderColor: theme === 'dark' ? 'var(--dark-card-bg, #1e1e1e)' : 'var(--light-card-bg, #fff)',
                          borderWidth: 2
                      },
                      label: {
                          show: true,
                          position: 'outside',
                          formatter: '{b}: {d}%'
                      },
                      emphasis: {
                          label: { show: true, fontSize: 18, fontWeight: 'bold' }
                      },
                      labelLine: { show: true },
                      data: pieData
                  }
              ],
              toolbox: {
                  show: true,
                  feature: {
                      mark: { show: true },
                      saveAsImage: { show: true }
                  }
              }
          };
          screenChartInstance.setOption(option);
          screenChartInstance.on('legendselectchanged', (params) => {
              if (allDeviceNames.includes(params.name) && params.selected[params.name] === true && params.name !== currentSelectedDevice) {
                   updateChartOptions(params.name);
              }
          });
          const resizeObserver = new ResizeObserver(() => {
              if (screenChartInstance) {
                  screenChartInstance.resize();
              }
          });
          resizeObserver.observe(chartDom);
      }
      async function main() {
          try {
              const keyResponse = await fetch('./upload/screen/get-encryption-key.php');
              if (!keyResponse.ok) throw new Error(`获取密钥失败! 状态: ${keyResponse.status}`);
              const keyPayload = await keyResponse.json();
              if (keyPayload.error) throw new Error(keyPayload.error);
              const keyData = base64ToArrayBuffer(keyPayload.key);
              const dataResponse = await fetch('./upload/screen/get_screen_data.php');
              if (!dataResponse.ok) throw new Error(`获取数据失败! 状态: ${dataResponse.status}`);
              const encryptedPayload = await dataResponse.json();
              if (encryptedPayload.error) throw new Error(encryptedPayload.error);
              const decryptedJson = await decryptData(
                  keyData,
                  encryptedPayload.ciphertext,
                  encryptedPayload.iv,
                  encryptedPayload.tag
              );
              const data = JSON.parse(decryptedJson);
              if (data.error) throw new Error(data.error);
              allScreenData = data;
              allDeviceNames = ['所有设备', ...new Set(allScreenData.map(item => item.device_model))];
              renderScreenChart('所有设备');
          } catch (error) {
              console.error("加载或渲染图表失败:", error);
              if (chartDom) {
                  chartDom.innerHTML = `<div class="retext">错误: ${error.message}</div>`;
                  chartDom.style.height = '100px';
              }
          }
      }
      const themeObserver = new MutationObserver((mutationsList) => {
          for (const mutation of mutationsList) {
              if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                  renderScreenChart(currentSelectedDevice);
                  break;
              }
          }
      });
      themeObserver.observe(document.documentElement, { attributes: true });
      main();
    })();
  </script>
</body>
</html>
