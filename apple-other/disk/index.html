<!DOCTYPE html>
<html lang="zh-CN" style="height: 100%">
<head>
  <meta charset="utf-8">
  <link rel="stylesheet" type="text/css" href="../../public-static/css/new.css" />
  <style type="text/css">
    .main-content { padding: 20px; }
    .card { margin-bottom: 20px; }
    .retext { text-align: center; font-size: 1.2rem; font-weight: 500; margin-top: 20px; margin-bottom: 20px; color: var(--light-text-secondary); width: 100%; }
    hr { border: 0; height: 1px; background-color: rgba(237, 237, 237, 0.3); max-width: 1500px; margin: 40px auto; }
    #mainLayout { margin: 0; }
    .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px; }
    .summary-card { padding: 15px; border-radius: 8px; background-color: var(--light-bg-secondary); }
    .summary-card h3 { margin-top: 0; }
    .summary-card .capacity-note { font-size: 0.8em; opacity: 0.8; }
    .detail-table { width: 100%; border-collapse: collapse; font-size: 0.9em; }
    .detail-table th, .detail-table td { padding: 8px 12px; border: 1px solid rgba(237, 237, 237, 0.5); text-align: left; }
    .detail-table th { background-color: var(--light-bg-secondary); }

    html.dark-mode .retext { color: var(--dark-text-secondary); }
    html.dark-mode hr { background-color: rgba(255, 255, 255, 0.15); }
    html.dark-mode .card { box-shadow: 0 2px 4px rgba(255, 255, 255, 0.05); }
    html.dark-mode .summary-card { background-color: var(--dark-bg-secondary); }
    html.dark-mode .detail-table th, html.dark-mode .detail-table td { border-color: rgba(255, 255, 255, 0.2); }
    html.dark-mode .detail-table th { background-color: var(--dark-bg-secondary); }

    @media (max-width: 768px) {
      .main-content { padding: 5px; }
      .card { margin: 0; }
    }
  </style>
</head>
<body style="margin: 0;" id="mainLayout">
  <div class="main-content">
    <div class="card">
        <h2>磁盘详细信息</h2>
        <div id="summarySection" class="summary-grid"></div>
        <hr>
        <h2>详细数据列表</h2>
        <div style="overflow-x:auto;">
            <table class="detail-table">
                <thead>
                    <tr>
                        <th>设备型号</th>
                        <th>厂商</th>
                        <th>颗粒</th>
                        <th>计算总容量</th>
                        <th>总 Band 数</th>
                        <th>User Bands</th>
                        <th>Intermediate Bands</th>
                        <th>Skinny Bands</th>
                        <th>Utility Bands</th>
                        </tr>
                </thead>
                <tbody id="detailTableBody">
                </tbody>
            </table>
        </div>
        <div id="noDataMessage"></div>
    </div>
  </div>
  <script type="text/javascript">
    (async () => {
      const formatBytes = (bytes, decimals = 2) => {
          if (!+bytes) return '0 Bytes';
          const k = 1000;
          const dm = decimals < 0 ? 0 : decimals;
          const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB'];
          const i = Math.floor(Math.log(bytes) / Math.log(k));
          return `${parseFloat((bytes / Math.pow(k, i)).toFixed(dm))} ${sizes[i]}`;
      };

      const formatNominalCapacityLabel = (gb) => {
          const numGb = parseInt(gb, 10);
          if (isNaN(numGb)) return 'N/A';
          if (numGb >= 1000) {
              return `${numGb / 1000} TB`;
          }
          return `${numGb} GB`;
      };

      const renderSummary = (summary) => {
          const container = document.getElementById('summarySection');
          if (!container || !summary) return;
          
          let manufacturerHtml = '<h3>厂商分布</h3>';
          for(const [name, count] of Object.entries(summary.manufacturers || {})) {
              manufacturerHtml += `${name}: ${count} 次<br>`;
          }

          let cellTypeHtml = '<h3>颗粒类型分布</h3>';
          for(const [name, count] of Object.entries(summary.cell_types || {})) {
              cellTypeHtml += `${name}: ${count} 次<br>`;
          }
          
          let capDistroHtml = '<h3>物理容量分布</h3>';
          capDistroHtml += '<div style="column-count: 2; column-gap: 25px;">';

          if (summary.capacity_distribution && Object.keys(summary.capacity_distribution).length > 0) {
              for(const [nominal, data] of Object.entries(summary.capacity_distribution)) {
                  const nominalLabel = formatNominalCapacityLabel(nominal);
                  capDistroHtml += `
                    <div style="margin-top: 8px; break-inside: avoid; padding-bottom: 10px;">
                      <strong>${nominalLabel} 标称 </strong>
                      <span class="capacity-note">(${data.total_samples}个总样本)</span>
                  `;
                  for (const [bytes, count] of Object.entries(data.distribution || {})) {
                      capDistroHtml += `
                          <div style="margin-left: 15px; font-size: 0.9em;">
                             - ${formatBytes(bytes)}: <span class="capacity-note">${count}个样本</span>
                          </div>
                      `;
                  }
                  capDistroHtml += `</div>`;
              }
          } else {
              capDistroHtml += `<span class="capacity-note">无数据</span>`;
          }
          capDistroHtml += '</div>';

          container.innerHTML = `
              <div class="summary-card"><h3>总提交数</h3><p style="font-size: 1.5em;">${summary.total_submissions || 0}</p></div>
              <div class="summary-card">${manufacturerHtml}</div>
              <div class="summary-card">${cellTypeHtml}</div>
              <div class="summary-card" style="grid-column: span 2;">${capDistroHtml}</div>
          `;
      };
      
      const renderTable = (rows) => {
          const tableBody = document.getElementById('detailTableBody');
          const noDataContainer = document.getElementById('noDataMessage');
          if (!tableBody || !noDataContainer) return;

          if (!rows || rows.length === 0) {
              noDataContainer.innerHTML = `<div class="retext">无可用数据。<br>请先通过上传页面提交数据。</div>`;
              return;
          }
          
          let tableHtml = '';
          rows.forEach(row => {
              tableHtml += `
                  <tr>
                      <td>${row.device_model || 'N/A'}</td>
                      <td>${row.manufacturer || 'N/A'}</td>
                      <td>${row.cell_type || 'N/A'}</td>
                      <td>${formatBytes(row.total_capacity_bytes_new)}</td>
                      <td>${row.bands_total || '0'}</td>
                      <td>${row.bands_user || '0'}</td>
                      <td>${row.bands_intermediate || '0'}</td>
                      <td>${row.bands_skinny || '0'}</td>
                      <td>${row.bands_utility || '0'}</td>
                      </tr>
              `;
          });
          tableBody.innerHTML = tableHtml;
      };

      const base64ToArrayBuffer = (base64) => {
          const binaryString = window.atob(base64);
          const len = binaryString.length;
          const bytes = new Uint8Array(len);
          for (let i = 0; i < len; i++) {
              bytes[i] = binaryString.charCodeAt(i);
          }
          return bytes.buffer;
      };

      const decryptData = async (keyData, b64Ciphertext, b64Iv, b64Tag) => {
          const cryptoKey = await window.crypto.subtle.importKey("raw", keyData, { name: "AES-GCM" }, false, ["decrypt"]);
          const ciphertext = base64ToArrayBuffer(b64Ciphertext);
          const iv = base64ToArrayBuffer(b64Iv);
          const tag = base64ToArrayBuffer(b64Tag);
          const fullCiphertext = new Uint8Array(ciphertext.byteLength + tag.byteLength);
          fullCiphertext.set(new Uint8Array(ciphertext), 0);
          fullCiphertext.set(new Uint8Array(tag), ciphertext.byteLength);
          const decrypted = await window.crypto.subtle.decrypt({ name: "AES-GCM", iv: iv, tagLength: 128 }, cryptoKey, fullCiphertext.buffer);
          return new TextDecoder().decode(decrypted);
      };

      const main = async () => {
          try {
              const keyResponse = await fetch('./upload/disk/get-encryption-key.php');
              if (!keyResponse.ok) throw new Error(`获取密钥失败! 状态: ${keyResponse.status}`);
              const keyPayload = await keyResponse.json();
              if (keyPayload.error) throw new Error(keyPayload.error);
              
              const keyData = base64ToArrayBuffer(keyPayload.key);

              const dataResponse = await fetch('./upload/disk/get-disk-data.php');
              if (!dataResponse.ok) throw new Error(`获取数据失败! 状态: ${dataResponse.status}`);
              const encryptedPayload = await dataResponse.json();
              if (encryptedPayload.error) throw new Error(encryptedPayload.error);
              
              const decryptedJson = await decryptData(keyData, encryptedPayload.ciphertext, encryptedPayload.iv, encryptedPayload.tag);
              const data = JSON.parse(decryptedJson);
              if (data.error) throw new Error(data.error);
              
              renderSummary(data.summary);
              renderTable(data.rows);
          } catch (error) {
              console.error("加载或渲染数据失败:", error);
              document.querySelector('.main-content').innerHTML = `<div class="retext">错误: ${error.message}</div>`;
          }
      };
      main();
    })();
  </script>
</body>
</html>
